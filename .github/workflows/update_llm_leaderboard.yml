name: Update Top LLM Leaderboard

on:
  schedule:
    - cron: '0 3 * * *'   # tous les jours √† 03:00 UTC
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas requests beautifulsoup4

      - name: Run script to generate files
        run: python extract_leaderboard.py

      - name: Commit and push to main (robuste)
        run: |
          set -euo pipefail
          git config --global user.name  'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

          FILES=(top_llms.md top_llms.json)

          # Filtrer ceux qui existent
          EXISTING=()
          for f in "${FILES[@]}"; do
            [[ -f "$f" ]] && EXISTING+=("$f")
          done

          if (( ${#EXISTING[@]} == 0 )); then
            echo "‚ÑπÔ∏è Aucun fichier de sortie √† committer."
          else
            git add "${EXISTING[@]}"
            if git diff --cached --quiet; then
              echo "‚úÖ No changes to commit."
            else
              git commit -m "update: leaderboard [auto]"
              git push
              echo "üöÄ Changes committed and pushed to main."
            fi
          fi

      - name: Prepare site
        run: |
          set -euo pipefail
          mkdir -p site
          if [[ -f top_llms.md ]]; then
            cp top_llms.md site/index.md
          else
            # Placeholder si le fichier n'a pas √©t√© g√©n√©r√©
            cat > site/index.md << 'EOF'
# üèÜ Top LLMs

_Aucun contenu g√©n√©r√© lors de la derni√®re ex√©cution._
EOF
          fi

          # Footer HTML
          cat >> site/index.md << 'EOF'
<div align="center"><sub>Made with ‚ô• and automation.</sub></div>
<style>.footer { display: none; }</style>
EOF

          # Copier Jekyll config/includes si pr√©sents
          [[ -f _config.yml ]] && cp _config.yml site/
          [[ -d _includes  ]] && cp -r _includes site/

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./site
          publish_branch: gh-pages
          enable_jekyll: true
